---
title: "Extract  data"
author: "Dave Fifield"
date: "`r format(Sys.time(), '%d %B, %Y %H:%M:%S')`"
output: 
  html_document: 
    toc: yes
    number_sections: yes
editor_options: 
  chunk_output_type: console
---

```{r setup}
source(here::here("R/analysis_settings.R"), echo = T)
# load(studyAreaLoc)
```

# Import Ship-based data

## Extract ECSAS Survey data

Extract all data for ECSAS ship-based surveys. This will get everyting including
data in Pacific and Eastern Atlantic. I can do analysis for entire dataset and
then subset to areas of interest later.


```{r extract_ECSAS_ship}
if (ECSAS.reextract) {
  ecsas.ship.dat <- ECSAS.extract(
    distMeth = "All",
    intransect.only = FALSE, # Lets get everything in ECSAS
    years = c(2006, 2024),
    ecsas.path = ECSAS.Path
  )  

  write_rds(ecsas.ship.dat,
            file = file.path(GenDataDir, "ECSAS_ship_raw_data.rds"))
} else {
  ecsas.ship.dat <- read_rds(file.path(GenDataDir, "ECSAS_ship_raw_data.RDS")) 
}

progs <- ECSAS.get.table(ecsas.path = ECSAS.Path, "lkpProgram")
ecsas.ship.distdata <- ecsas.ship.dat %>%
  left_join(progs, by = c("Program" = "ProgramID")) %>%
  dplyr::filter(
    Program %in% c(4, 6),
    !is.na(Count),
    !is.na(DistMeth),
    !is.na(FlockID),
    FlySwim %in% c("W", "F"),
    DataSharing == 1
  ) %>%
  mutate(
    SurveyType = "Ship",
    spec.grp = find.spec.grp(Alpha),
    InTransect = case_when(InTransect == -1 ~ TRUE, 
                           InTransect == 0 ~ FALSE, 
                           .default = NA),
    Distance = Distance / 1000,
    # Distance = case_when(is.na(Distance) ~ 0, TRUE ~ Distance),
    DistType = assign.dist.type(.),
    Windspeed = case_when(
      is.na(Windspeed) &
        !is.na(Windforce) ~ left_join(., beaufort_conversion, 
                                      by = c("Windforce" = "beaufort"))$speed.kts,
      TRUE ~ Windspeed
    ),
    Visibility = case_when(Visibility > 20 ~ 20, TRUE ~ Visibility),
    FlySwim = as.factor(FlySwim),
    distbegin = NA_integer_,
    distend = NA_integer_,
    BlindWidth = NA,
  ) %>%
  rename(object = FlockID,
         size = Count,
         distance = Distance) %>%
  select(
    object,
    Alpha,
    Association,
    BlindWidth,
    DataSharing,
    Date,
    distance,
    distbegin,
    distend,
    DistMeth,
    DistType,
    English,
    FlySwim,
    InTransect,
    LatStart,
    LongStart,
    Seabird,
    SeaState,
    size,
    spec.grp,
    SurveyType,
    Swell,
    Waterbird,
    Windspeed,
    Year
  ) %>%
  droplevels


# Check to make sure all rows have DistMeth
stopifnot(all(!is.na(ecsas.ship.distdata$DistMeth)))

# Summary
summary(ecsas.ship.distdata)

write_rds(ecsas.ship.distdata,
     file = file.path(GenDataDir, "ECSAS_ship_the_data.rds"))
# ecsas.ship.distdata <- read_rds(file = file.path(GenDataDir,"ECSAS_ship_the_data.rds"))
```

# Import Aerial Data

## Import ECSAS aerial data

```{r create_ecsas_air_watch_trans}
# Import aerial data remove QC data for now since we have no positions for them.
ecsas.air.dat.on.effort <- readxl::read_xlsx(file.path(RawDataDir, "q Aerial on-effort data.xlsx")) %>% 
  filter(!is.na(AerialObsID),
         StudyAreaName != "GenericPQ",
         FlySwim %in% c("W", "F"),
         DataSharing == 1)  %>%
  select(
    AerialObsID,
    Alpha,
    Association,
    BlindWidth,
    Count,
    DataSharing,
    Distance_m,
    dist_begin,
    dist_end,
    DistMeth,
    English,
    FlySwim,
    InTransect,
    ObsLat,
    ObsLong,
    ObsTime,
    SeaState,
    Seabird,
    Waterbird
  )

# 7128 records

# Get off effort obs
ecsas.air.dat.off.effort <- readxl::read_xlsx(file.path(RawDataDir, "q Aerial off-effort data.xlsx")) %>%
  filter(StudyAreaName != "GenericPQ",
         FlySwim %in% c("W", "F"),
         DataSharing == 1) %>%
  select(
    AerialObsID,
    Alpha,
    Association,
    Count,
    DataSharing,
    Distance_m,
    dist_begin,
    dist_end,
    DistMeth,
    English,
    FlySwim,
    InTransect,
    ObsLat,
    ObsLong,
    ObsTime,
    Seabird,
    Waterbird
  ) %>%
  mutate(SeaState = NA, BlindWidth = NA)

# 153 obs

ecsas.air.distdata <- rbind(ecsas.air.dat.on.effort, ecsas.air.dat.off.effort) %>%
  rename(
    LatStart = ObsLat,
    LongStart = ObsLong,
    distbegin = dist_begin,
    distend = dist_end,
    Date = ObsTime,
    object = AerialObsID,
    size = Count,
    distance = Distance_m
  ) %>% 
  filter(!is.na(LatStart), !is.na(LongStart)) %>%  # Some off-effort have none
  mutate(
    SurveyType = "Air",
    DistType = "Perp.",
    Seabird = -1,
    Swell = NA,
    Windspeed = NA,
    distbegin = distbegin / 1000,
    distend = distend / 1000,
    spec.grp = find.spec.grp(Alpha),
    Year = year(Date),
    distance = case_when(is.na(distance) ~ 0, TRUE ~ distance)
  ) 

summary(ecsas.air.distdata)

write_rds(ecsas.air.distdata,
     file = file.path(GenDataDir, "ECSAS_air_the_data.rds"))
# ecsas.air.distdata <- read_rds(file = file.path(GenDataDir,"ECSAS_air_the_data.rds"))
```

# Create final data

```{r combine_all_data}
# Create combined ship/air study.area

distdata <- rbind(ecsas.ship.distdata, ecsas.air.distdata) %>% 
  write_rds(file = the.data.file)

# Save shapefile
distdata.sf <- distdata %>%
  mutate(object = as.character(object)) %>%  # shapefile can't handle big ints
  st_as_sf(
    coords = c("LongStart", "LatStart"),
    crs = 4326,
    remove = FALSE
  ) %>%
  st_write(
    dsn = ShapeDir,
    layer = "ECSAS_distdata.shp",
    driver = "ESRI Shapefile",
    delete_layer = TRUE
  )

# load(the.data.file)
```


## Create study area and save

Study area is just MCP of all points.

```{r ECSAS_ship_create_survey}
study.area <- distdata.sf %>%
  mutate(ID = 1) %>%
  select(ID, geometry) %>%
  as_Spatial() %>%
  adehabitatHR::mcp(percent = 100) %>%
  as("sf") %>%
  st_write(
    dsn = ShapeDir,
    layer = "study_area.shp",
    driver = "ESRI Shapefile",
    delete_layer = TRUE
  )

write_rds(study.area, study.area.file)
```


# Plot watches

```{r plot_watches}
dftools::plot_sf_obj(distdata, "LongStart", "LatStart")
```


# SessionInfo
```{r}
sessioninfo::session_info()
```
